(function(){var b=function(d,e){return function(){return d.apply(e,arguments)}},a=Object.prototype.hasOwnProperty,c=function(g,e){for(var d in e){if(a.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f;g.__super__=e.prototype;return g};Annotator.Plugin.Filter=(function(){c(d,Annotator.Plugin);d.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"};d.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}};d.prototype.html={element:'<div class="annotator-filter">\n  <strong>Navigate:</strong>\n  <span class="annotator-filter-navigation">\n    <button class="annotator-filter-previous">Previous</button>\n    <button class="annotator-filter-next">Next</button>\n  </span>\n  <strong>Filter by:</strong>\n</div>',filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">Clear</button>\n</span>'};d.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:true,isFiltered:function(g,j){var f,i,e,h;if(!(g&&j)){return false}h=g.split(/\s*/);for(i=0,e=h.length;i<e;i++){f=h[i];if(j.indexOf(f)===-1){return false}}return true}};function d(f,e){this._onPreviousClick=b(this._onPreviousClick,this);this._onNextClick=b(this._onNextClick,this);this._onFilterKeyup=b(this._onFilterKeyup,this);this._onFilterBlur=b(this._onFilterBlur,this);this._onFilterFocus=b(this._onFilterFocus,this);this.updateHighlights=b(this.updateHighlights,this);f=$(this.html.element).appendTo(this.options.appendTo);d.__super__.constructor.call(this,f,e);this.filter=$(this.html.filter);this.filters=[];this.current=0}d.prototype.pluginInit=function(){var f,h,e,g;g=this.options.filters;for(h=0,e=g.length;h<e;h++){f=g[h];this.addFilter(f)}this.updateHighlights();this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===true){return this.addFilter({label:"Annotation",property:"text"})}};d.prototype._insertSpacer=function(){var f,e;e=$("html");f=parseInt(e.css("padding-top"),10)||0;e.css("padding-top",f+this.element.outerHeight());return this};d.prototype._setupListeners=function(){var g,f,h,e;f=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(h=0,e=f.length;h<e;h++){g=f[h];this.annotator.subscribe(g,this.updateHighlights)}return this};d.prototype.addFilter=function(e){var h,g;g=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},e);if(!((function(){var k,i,j,f;j=this.filters;f=[];for(k=0,i=j.length;k<i;k++){h=j[k];if(h.property===g.property){f.push(h)}}return f}).call(this)).length){g.id="annotator-filter-"+g.property;g.annotations=[];g.element=this.filter.clone().appendTo(this.element);g.element.find("label").html(g.label).attr("for",g.id);g.element.find("input").attr({id:g.id,placeholder:"Filter by "+g.label+"\u2026"});g.element.find("button").hide();g.element.data("filter",g);this.filters.push(g)}return this};d.prototype.updateFilter=function(h){var e,l,g,k,j,f,i;h.annotations=[];this.updateHighlights();this.resetHighlights();g=$.trim(h.element.find("input").val());if(g){l=this.highlights.map(function(){return $(this).data("annotation")});i=$.makeArray(l);for(j=0,f=i.length;j<f;j++){e=i[j];k=e[h.property];if(h.isFiltered(g,k)){h.annotations.push(e)}}return this.filterHighlights()}};d.prototype.updateHighlights=function(){this.highlights=this.annotator.element.find(".annotator-hl:visible");return this.filtered=this.highlights.not(this.classes.hl.hide)};d.prototype.filterHighlights=function(){var e,f,h,k,i,j,m,l,g;e=$.grep(this.filters,function(n){return !!n.annotations.length});k=((g=e[0])!=null?g.annotations:void 0)||[];if(e.length>1){h=[];$.each(e,function(){return $.merge(h,this.annotations)});m=[];k=[];$.each(h,function(){if($.inArray(this,m)===-1){return m.push(this)}else{return k.push(this)}})}i=this.highlights;for(j=0,l=k.length;j<l;j++){f=k[j];i=i.not(f.highlights)}i.addClass(this.classes.hl.hide);this.filtered=this.highlights.not(this.classes.hl.hide);return this};d.prototype.resetHighlights=function(){this.highlights.removeClass(this.classes.hl.hide);this.filtered=this.highlights;return this};d.prototype._onFilterFocus=function(f){var e;e=$(f.target);e.parent().addClass(this.classes.active);return e.next("button").show()};d.prototype._onFilterBlur=function(f){var e;if(!f.target.value){e=$(f.target);e.parent().removeClass(this.classes.active);return e.next("button").hide()}};d.prototype._onFilterKeyup=function(f){var e;e=$(f.target).parent().data("filter");if(e){return this.updateFilter(e)}};d.prototype._findNextHighlight=function(j){var f,g,l,k,i,h,e,m;if(!this.highlights.length){return this}h=j?0:-1;m=j?-1:0;e=j?"lt":"gt";f=this.highlights.not("."+this.classes.hl.hide);l=f.filter("."+this.classes.hl.active);if(!l.length){l=f.eq(h)}g=l.data("annotation");k=f.index(l[0]);i=f.filter(":"+e+"("+k+")").not(g.highlights).eq(m);if(!i.length){i=f.eq(m)}return this._scrollToHighlight(i.data("annotation").highlights)};d.prototype._onNextClick=function(e){return this._findNextHighlight()};d.prototype._onPreviousClick=function(e){return this._findNextHighlight(true)};d.prototype._scrollToHighlight=function(e){e=$(e);this.highlights.removeClass(this.classes.hl.active);e.addClass(this.classes.hl.active);return $("html, body").animate({scrollTop:e.offset().top-(this.element.height()+20)},150)};d.prototype._onClearClick=function(e){return $(e.target).prev("input").val("").keyup().blur()};return d})()}).call(this);